---
title:  "[#] Kernel Debugging with Vagrant"
tags: [Post, Windows, kernel, Reversing]
published: true
permalink: vagrant.html
comments: true
summary: "Vagrant를 이용한 커널 디버깅"
---

## [0x00] Overview

커널 디버깅을 진행하기 위한 선행 작업으로 가상머신 설정에 많은 시간을 소모합니다. 이러한 설정을 좀 더 가볍게 할 수 있도록 `Vagrant`를 이용할 수 있습니다. 쉽게 생각하면 도커와 비슷한 개념으로 생각할 수 있습니다. 해당 글에서는 이러한 `Vagrant`를 이용하여 커널 디버깅을 좀 더 쉽게 설정하고 자동화할 수 있는 방법에 대해 설명합니다.

이 글에서는 `Vagrant`와 `Hypervisor`가 설치되었다는 가정하에 진행합니다. <a href="https://www.vagrantup.com/downloads.html">이곳을 클릭</a> 하여 다운로드 받을 수 있습니다.

`Vagrant`가 지원하는 하이퍼바이저는 아래와 같습니다.

- VirtualBox
- VMWare
- Hyper-V

제공되는 내용에서는 `VirtualBox`를 이용합니다. 다만 공식 가이드에서는 안정성과 속도의 측면에서 `VMWare`를 추천한다고 되어있습니다. 

{% include note.html content="가상머신에 설치하는 운영체제는 Windows 10 1909, (빌드 18363.418) 을 사용하였습니다." %}



## [0x01] Create Box Image

`Vagrant`에는 최소 디스크 크기의 이미지인 `box` 라는 개념을 가지고 있습니다. 부팅하는데 최소한의 소프트웨어만 존재하는 상태를 의미합니다. 이러한 박스는 쉘 스크립트를 이용하여 가상 머신 템플릿을 구성할 수 있습니다. <a href="https://app.vagrantup.com/boxes/search">Vagrant Cloud</a> 에는 다른 사용자가 공개적으로 사용 가능한 박스 이미지들이 업로드되어 있습니다. 해당 부분은 아래의 활용 부분에서 더 다루도록 하겠습니다.

먼저 게스트 OS를 설치 후 계정명과 패스워드는 `"vagrant"`로 설정해야 합니다. 설치 후 [Vagrant Documentation](https://www.vagrantup.com/docs/boxes/base.html#Windows Boxes) 에 따르면 다음과 같은 작업이 필요합니다.

- Install the guest tools for your hypervisor.
- Ensure the virtual network adapter is configured as a private network.
- Completely disable UAC.
- Disable complex passwords.
- Disable Shutdown Tracker.

그리고 `Vagrant`가 게스트 OS  내에서 스크립트를 실행할 수 있도록 `winrm`을 사용하여 원격 관리를 활성화해야 합니다. 관리자 권한으로 명령 프롬프트를 실행하고 다음과 같이 실행하십시오.

```
winrm quickconfig -q
winrm set winrm/config/winrs @{MaxMemoryPerShellMB="512"}
winrm set winrm/config @{MaxTimeoutms="1800000"}
winrm set winrm/config/service @{AllowUnencrypted="true"}
winrm set winrm/config/service/auth @{Basic="true"}
sc config WinRM start= auto
```

이제 위에서 말한 박스 이미지로 만들 수 있는 하나의 게스트 OS가 완성되었습니다. 아무런 작업을 하지말고 게스트 OS를 종료하십시오.

**작성중입니다.**