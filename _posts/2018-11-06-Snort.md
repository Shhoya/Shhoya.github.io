---
layout: article
title: "[Web]Snort Rule"
key: 20181106
tags:
  - Web
  - Security
  - IDS
  - IPS
toc: true
mathjax: true
mathjax_autoNumber: true
---

# [+] Snort Rule

<!--more-->

## [+] Summary

### 구조

Snort 룰은 크게 Header와 Option으로 나눌 수 있다.
여러 블로그들을 찾아봤지만 뭐니뭐니해도 오피셜이 최고니깐 공식 홈페이지에서 가이드를 확인해봤다.

ex) `alert tcp any any -> 192.168.1.0/24 111 (content:"|00 01 86 a5|"; msg:"mountd access";)`

## [+] Header

헤더에는 다음과 같은 정보를 작성한다.

1. Rule Actions
2. Protocols
3. IP Addresses
4. Port Numbers
5. The Direction Operator
6. Activate/Dynamic Rules

### Rule Actions

스노트에는 기본적으로 3가지 동작이 존재한다. `alert`, `log`, `pass` 가 기본동작이다. 만약에 스노트가 인라인 모드에서 동작 중이라면 `drop`, `reject`, `sdrop`과 같은 동작도 가능하다(IPS기능).

- alert

  :  룰에 일치하는 경우 경고를 발생 시키고 로그로 기록한다.

- log

  :  로그로 기록한다.

- pass

  : 패킷을 무시한다.

- drop

  : 패킷을 차단하고 로그로 남긴다.

- reject

  : 패킷을 차단하고 로그로 남긴다, 그리고 tcp 패킷의 경우 `rst` 패킷을 응답하고 udp 패킷의 경우 `icmp unreachable` 패킷으로 응답한다.

- sdrop

  : 패킷을 차단하고 로그를 남기지 않는다.



### Protocols

TCP, UDP, ICMP, IP 프로토콜이 사용 가능하다. 앞으로 더 많은 프로토콜을 지원 예정이라고 하지만 이 가이드가 꽤 되어보여서... 모르겠다. 어쨋든 주요 프로토콜은 지원



### IP Addresses

IP 주소와 포트정보에 대한 필드이다. 호스트 네임을 찾는 메커니즘이 존재하지 않기 때문에 직접적인 IP 주소와 CIDR표기법을 사용할 수 있다. `any`의 경우 임의의 모든 것을 의미한다.

- example
  1. alert tcp !192.168.1.0/24 any -> 192.168.1.0/24 111 (content:"|00 01 86 a5|"; msg:"external mountd access";)
  2. alert tcp ![192.168.1.0/24,10.1.1.0/24] any -> [192.168.1.0/24,10.1.1.0/24] 111 (content:"|00 01 86 a5|"; msg:"external mountd access";)

1번 예제의 경우 논리부정연산자('`!`')를 이용한 표기법이고, 2번 예제는 여러 IP주소에 대한 표기 방법(`[]`)에 대한 예제이다. 콤마('`,`')로 구분한다.



### Port Numbers

특정 포트의 범위나 단일 포트를 표현할 수 있다.

- example
  1. 1:1024 = 1 ~ 1024 port
  2. :1024 = 1024 port 이하
  3. 1024: = 1024 port 이상
  4. !1:1024 = 1 ~ 1024 port를 제외한 나머지 port



### The Direction Operator

방향 연산자를 표현한다. 즉, 규칙이 적용되는 트래픽의 방향을 나타낸다.
`->` 의 경우 outgoing 패킷을 의미, `<-` 의 경우 ingoing 패킷을 의미한다.
또한 `<>` 으로 양방향을 의미하도록 할 수 있다.



### Activate/Dynamic Rule

이건 패쓰.!



## [+] Rule Options

룰에 대한 옵션이 스노트 룰의 핵심이다. 모든 규칙은 세미콜론('`;`')으로 구분하며 옵션 키워드는 콜론('`:`')으로 표현한다. 총 4개 general, payload, non-payload, post-detection 으로 구분된다

- general

  : 룰에 대한 정보를 포함하는 옵션

- payload

  : 패킷 내 페이로드 내부의 데이터를 찾고 상호작용을 할 수 있는 옵션

- non-payload

  : 페이로드가 없는 데이터에서 사용

- Post-detection

  : 사후탐지에 대한 옵션, 룰 실행 후의 규칙

1. General Options

   - msg

     : alert 엔진을 통해 전달하는 메시지를 설정할 수 있다.

     - example

       : `msg:"<message text>";`

   - reference

     :  CVE, nessus, mcafee 등 다른 외부 참조를 통해 규칙을 참조할 수 있다.

     - example

       : `reference:<id system>, <id>; [reference:<id system>, <id>;]`

   - gid

     : gid란 generator id 를 의미한다. 일반적인 규칙을 사용할 때 사용하지 않는 것이 좋다고 나와있다. 어떤 규칙이 실행될 때 스노트의 어떤 부분이 이벤트를 생성하는지 식별하는데 사용된다고 한다.

     - example

       : `gid:<generator id>;`

   - sid

     : Snort ID의 약자로 룰을 식별하기 위해 사용된다. 해당 옵션은 `rev` 키워드와 함께 사용되야 된다. pdf로 된 가이드 기준으로 `sid` 범위를 작성해 놓는다.

     - 100 이하의 sid 의 경우 예약된 sid
     - 100 ~ 999,999 까지는 기본 포함된 스노트 룰 sid
     - 1,000,000 이상의 sid는 유저가 작성가능한 로컬 룰

     - example

       : `sid:<snort rules id>;`

   - rev

     : `rev` 키워드의 경우 해당 룰의 버전 정보 ? 를 표현할 수 있는 영역이다.

     - example

       : `rev:<revision integer>;`

   - classtype

     : 특정 공격에 대한 분류를 하는데 사용된다. Snort에서 제공되는 특정 공격들에 대한 분류를 이용한다. 

     - example

       : `classtype:<class name>;`

       | Classtype                      | Description                                                 | Priority |
       | ------------------------------ | ----------------------------------------------------------- | -------- |
       | attempted-admin                | Attempted Administrator Privilege Gain                      | high     |
       | attempted-user                 | Attempted User Privilege Gain                               | high     |
       | inappropriate-content          | Inappropriate Content was Detected                          | high     |
       | policy-violation               | Potential Corporate Privacy Violation                       | high     |
       | shellcode-detect               | Executable code was detected                                | high     |
       | successful-admin               | Successful Administrator Privilege Gain                     | high     |
       | successful-user                | Successful User Privilege Gain                              | high     |
       | trojan-activity                | A Network Trojan was detected                               | high     |
       | unsuccessful-user              | Unsuccessful User Privilege Gain                            | high     |
       | web-application-attack         | Web Application Attack                                      | high     |
       | attempted-dos                  | Attempted Denial of Service                                 | medium   |
       | attempted-recon                | Attempted Information Leak                                  | medium   |
       | bad-unknown                    | Potentially Bad Traffic                                     | medium   |
       | default-login-attempt          | Attempt to login by a default username and password         | medium   |
       | denial-of-service              | Detection of a Denial of Service Attack                     | medium   |
       | misc-attack                    | Misc Attack                                                 | medium   |
       | non-standard-protocol          | Detection of a non-standard protocol or event               | medium   |
       | rpc-portmap-decode             | Decode of an RPC Query                                      | medium   |
       | successful-dos                 | Denial of Service                                           | medium   |
       | successful-recon-largescale    | Large Scale Information Leak                                | medium   |
       | successful-recon-limited       | Information Leak                                            | medium   |
       | suspicious-filename-detect     | A suspicious filename was detected                          | medium   |
       | suspicious-login               | An attempted login using a suspicious username was detected | medium   |
       | system-call-detect             | A system call was detected                                  | medium   |
       | unusual-client-port-connection | A client was using an unusual port                          | medium   |
       | web-application-activity       | Access to a potentially vulnerable web application          | medium   |
       | icmp-event                     | Generic ICMP event                                          | low      |
       | misc-activity                  | Misc activity                                               | low      |
       | network-scan                   | Detection of a Network Scan                                 | low      |
       | not-suspicious                 | Not Suspicious Traffic                                      | low      |
       | protocol-command-decode        | Generic Protocol Command Decode                             | low      |
       | string-detect                  | A suspicious string was detected                            | low      |
       | unknown                        | Unknown Traffic                                             | low      |
       | tcp-connection                 | A TCP connection was detected                               | very low |

   - priority

     : 우선순위를 지정할 수 있다.

     - example

       : `priority:<priority integer>;`

2. Payload Detection Rule Options

   퇴근해야되므로 내일 계쏙