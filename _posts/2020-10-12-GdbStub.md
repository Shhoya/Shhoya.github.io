---
title:  "[#] Windows GDB Stub"
tags: [Post, Windows, kernel, Reversing]
published: true
permalink: gdbstub.html
comments: true
summary: "IDA GDB를 이용한 VMware 커널 디버깅"
---

## [0x00] Overview

Windows Kernel 디버깅에 있어서 `windbg`는 정말 가장 강력한 도구입니다. 때문에 해당 포스트가 필요 없을 수 있습니다. 다만 `IDA`에서는 `GDB`를 이용한 디버깅이 가능하고 이를 이용하여 Windows Kernel 디버깅이 가능합니다.

`windbg`의 전통적인 디버깅 방법과는 다르게 동작하기 때문에 꽤 유용하게 사용될 수 있습니다. 예를 들어 PatchGuard 우회 시 사용되는 기법 중 하나인 `HalNotifyProcessorFreeze` 후킹의 경우에도 `windbg`는 BSOD를 발생시킵니다.

어쨋든 여러가지 이유로 `GDB Stub`은 유용합니다.



## [0x01] Enable VMware GDB Stub

가상머신 파일이 존재하는 디렉토리에 가서 `.vmx` 파일을 아래와 같이 수정해야 합니다.

- x86 Local Debugging : `debugStub.listen.guest32 = "TRUE"`
- x64 Local Debugging : `debugStub.listen.guest64 = "TRUE"`
- x86 Remote Debugging : `debugStub.listen.guest32.remote = "TRUE"`
- x64 Remote Debugging : `debugStub.listen.guest64.remote = "TRUE"`

다음은 호스트와 통신할 디버깅 포트에 대한 설정을 해줘야 합니다. 기본적으로 x64 guest는 8864 포트, x86 guest는 8832 포트를 사용합니다. 변경하려면 아래와 같이 수정합니다.

- x86 : `debugStub.port.guest32 = "33333"`
- x64 : `debugStub.port.guest64 = "33333"`

BIOS 로드 시 즉시 디버깅을 사용하는 경우 아래와 같이 추가합니다.

- x86 : `monitor.debugOnStartGuest32 = "TRUE"`
- x64 : `monitor.debugOnStartGuest64 = "TRUE"`

마지막으로 브레이크 포인트를 하드웨어 브레이크포인트를 이용하려는 경우 아래와 같이 추가합니다.

- `debugStub.hideBreakpoints = "TRUE"`

{% include important.html content="브레이크 포인트 설정의 경우 기본 브레이크 포인트를 하드웨어 브레이크 포인트로 대체하기 때문에 4개의 제한이 생깁니다." %}

위에서 필요한 내용들을 `.vmx` 마지막 줄에 추가하고 저장합니다.

<img src="https://github.com/Shhoya/shhoya.github.io/blob/master/rsrc/post/gdbstub_0.png?raw=true">



## [0x02] IDA Setup

이제 IDA에서 설정이 필요합니다. `Debugger -> Attach -> Remote GDB debugger` 를 선택하고 아래와 같이 설정해야 합니다.

<img src="https://github.com/Shhoya/shhoya.github.io/blob/master/rsrc/post/gdbstub_1.png?raw=true">

**작성중**

